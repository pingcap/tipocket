metadata:
  name: tipocket-cdc
  namespace: argo
spec:
  templates:
    - name: tipocket-cdc
      inputs:
        parameters:
          - name: ns
            default: tipocket-cdc
          - name: purge
            default: "false"
          - name: hub
            default: "docker.io"
          - name: repository
            default: pingcap
          - name: image-version
            default: nightly
          - name: tidb-image
            default: ""
          - name: tikv-image
            default: ""
          - name: pd-image
            default: ""
          - name: storage-class
            default: local-path
          - name: nemesis
            default: ""
          - name: run-time
            default: "48h"
          - name: tikv-config
            default: ""
          - name: cdc_version
            default: nightly
          - name: cdc_enable-kafka
            default: "false"
          - name: cdc_kafka-consumer-image
            default: "docker.io/pingcap/ticdc-kafka:nightly"
          - name: cdc_sort-engine
            default: "memory"
          - name: cdc_sort-dir
            default: "/tmp/sort_cache"
          - name: abtest_general-log
            default: "true"
          - name: binlog_sync-timeout
            default: "1h"
          - name: abtest_concurrency
            default: "3"
          - name: matrix-config
            default: ""
          - name: matrix-tidb
            default: "tidb.toml"
          - name: matrix-tikv
            default: "tikv.toml"
          - name: matrix-pd
            default: "pd.toml"
          - name: matrix-sql
            default: "mysql-system-vars.sql,tidb-system-vars.sql"
      outputs:
        artifacts:
          - name: case-logs
            archiveLogs: true
            path: /logs
      metadata:
        labels:
          ns: "{{inputs.parameters.ns}}"
      container:
        name: tipocket
        image: 'hub.pingcap.net/qa/tipocket:latest'
        imagePullPolicy: Always
        workingDir: /logs
        command:
          - sh
          - '-c'
          - |
            /bin/cdc-pocket \
            -namespace={{inputs.parameters.ns}} \
            -hub={{inputs.parameters.hub}} \
            -repository={{inputs.parameters.repository}} \
            -storage-class={{inputs.parameters.storage-class}} \
            -image-version={{inputs.parameters.image-version}} \
            -tidb-image={{inputs.parameters.tidb-image}} \
            -tikv-image={{inputs.parameters.tikv-image}} \
            -pd-image={{inputs.parameters.pd-image}} \
            -purge={{inputs.parameters.purge}} \
            -delNS=true \
            -nemesis={{inputs.parameters.nemesis}} \
            -run-time={{inputs.parameters.run-time}} \
            -tikv-config={{inputs.parameters.tikv-config}} \
            -cdc.version={{inputs.parameters.cdc_version}} \
            -cdc.enable-kafka={{inputs.parameters.cdc_enable-kafka}} \
            -cdc.kafka-consumer-image={{inputs.parameters.cdc_kafka-consumer-image}} \
            -cdc.sort-engine={{inputs.parameters.cdc_sort-engine}} \
            -cdc.sort-dir={{inputs.parameters.cdc_sort-dir}} \
            -abtest.concurrency={{inputs.parameters.abtest_concurrency}} \
            -abtest.general-log={{inputs.parameters.abtest_general-log}} \
            -binlog.sync-timeout={{inputs.parameters.binlog_sync-timeout}} \
            -matrix-config={{inputs.parameters.matrix-config}} \
            -matrix-tidb={{inputs.parameters.matrix-tidb}} \
            -matrix-tikv={{inputs.parameters.matrix-tikv}} \
            -matrix-pd={{inputs.parameters.matrix-pd}} \
            -matrix-sql={{inputs.parameters.matrix-sql}}
